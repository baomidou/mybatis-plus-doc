---
title: å¤šæ•°æ®æº
date: 2021-12-14 19:08:10
permalink: /pages/a61e1b/
article: false
---

å¤šæ•°æ®æºæ—¢åŠ¨æ€æ•°æ®æºï¼Œé¡¹ç›®å¼€å‘é€æ¸æ‰©å¤§ï¼Œå•ä¸ªæ•°æ®æºã€å•ä¸€æ•°æ®æºå·²ç»æ— æ³•æ»¡è¶³éœ€æ±‚é¡¹ç›®çš„æ”¯æ’‘éœ€æ±‚ã€‚

ç”±æ­¤å»¶ä¼¸äº†å¤šæ•°æ®æºçš„æ‰©å±•ï¼Œä¸‹æ–‡æä¾›äº†ä¸¤ç§ä¸åŒæ–¹å‘çš„æ‰©å±•æ’ä»¶ã€‚

- `dynamic-datasource` å¼€æºæ–‡æ¡£ä»˜è´¹ï¼Œå±äºç»„ç»‡å‚ä¸è€…`å°é”…ç›–`å‘èµ·çš„é¡¹ç›®

- `mybatis-mate` ä¼ä¸šçº§ä»˜è´¹æˆæƒï¼Œèµ„æ–™æ–‡æ¡£å…è´¹ 


## dynamic-datasource

springboot å¿«é€Ÿé›†æˆå¤šæ•°æ®æºçš„å¯åŠ¨å™¨ [ä½¿ç”¨æ–‡æ¡£](https://www.kancloud.cn/tracy5546/dynamic-datasource/2264611)

- æ”¯æŒ **æ•°æ®æºåˆ†ç»„** ï¼Œé€‚ç”¨äºå¤šç§åœºæ™¯ çº¯ç²¹å¤šåº“ è¯»å†™åˆ†ç¦» ä¸€ä¸»å¤šä» æ··åˆæ¨¡å¼ã€‚
- æ”¯æŒæ•°æ®åº“æ•æ„Ÿé…ç½®ä¿¡æ¯ **åŠ å¯†**  ENC()ã€‚
- æ”¯æŒæ¯ä¸ªæ•°æ®åº“ç‹¬ç«‹åˆå§‹åŒ–è¡¨ç»“æ„schemaå’Œæ•°æ®åº“databaseã€‚
- æ”¯æŒæ— æ•°æ®æºå¯åŠ¨ï¼Œæ”¯æŒæ‡’åŠ è½½æ•°æ®æºï¼ˆéœ€è¦çš„æ—¶å€™å†åˆ›å»ºè¿æ¥ï¼‰ã€‚
- æ”¯æŒ **è‡ªå®šä¹‰æ³¨è§£** ï¼Œéœ€ç»§æ‰¿DS(3.2.0+)ã€‚
- æä¾›å¹¶ç®€åŒ–å¯¹Druidï¼ŒHikariCpï¼ŒBeeCp,Dbcp2çš„å¿«é€Ÿé›†æˆã€‚
- æä¾›å¯¹Mybatis-Plusï¼ŒQuartzï¼ŒShardingJdbcï¼ŒP6syï¼ŒJndiç­‰ç»„ä»¶çš„é›†æˆæ–¹æ¡ˆã€‚
- æä¾› **è‡ªå®šä¹‰æ•°æ®æºæ¥æº** æ–¹æ¡ˆï¼ˆå¦‚å…¨ä»æ•°æ®åº“åŠ è½½ï¼‰ã€‚
- æä¾›é¡¹ç›®å¯åŠ¨å **åŠ¨æ€å¢åŠ ç§»é™¤æ•°æ®æº** æ–¹æ¡ˆã€‚
- æä¾›Mybatisç¯å¢ƒä¸‹çš„  **çº¯è¯»å†™åˆ†ç¦»** æ–¹æ¡ˆã€‚
- æä¾›ä½¿ç”¨ **spelåŠ¨æ€å‚æ•°** è§£ææ•°æ®æºæ–¹æ¡ˆã€‚å†…ç½®spelï¼Œsessionï¼Œheaderï¼Œæ”¯æŒè‡ªå®šä¹‰ã€‚
- æ”¯æŒ  **å¤šå±‚æ•°æ®æºåµŒå¥—åˆ‡æ¢** ã€‚ï¼ˆServiceA >>>  ServiceB >>> ServiceCï¼‰ã€‚
- æä¾›  **åŸºäºseataçš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆã€‚
- æä¾›  **æœ¬åœ°å¤šæ•°æ®æºäº‹åŠ¡æ–¹æ¡ˆã€‚**

> çº¦å®š

1. æœ¬æ¡†æ¶åªåš **åˆ‡æ¢æ•°æ®æº** è¿™ä»¶æ ¸å¿ƒçš„äº‹æƒ…ï¼Œå¹¶**ä¸é™åˆ¶ä½ çš„å…·ä½“æ“ä½œ**ï¼Œåˆ‡æ¢äº†æ•°æ®æºå¯ä»¥åšä»»ä½•CRUDã€‚
2. é…ç½®æ–‡ä»¶æ‰€æœ‰ä»¥ä¸‹åˆ’çº¿ `_` åˆ†å‰²çš„æ•°æ®æº **é¦–éƒ¨** å³ä¸ºç»„çš„åç§°ï¼Œç›¸åŒç»„åç§°çš„æ•°æ®æºä¼šæ”¾åœ¨ä¸€ä¸ªç»„ä¸‹ã€‚
3. åˆ‡æ¢æ•°æ®æºå¯ä»¥æ˜¯ç»„åï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“æ•°æ®æºåç§°ã€‚ç»„ååˆ™åˆ‡æ¢æ—¶é‡‡ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•åˆ‡æ¢ã€‚
4. é»˜è®¤çš„æ•°æ®æºåç§°ä¸º  **master** ï¼Œä½ å¯ä»¥é€šè¿‡ `spring.datasource.dynamic.primary` ä¿®æ”¹ã€‚
5. æ–¹æ³•ä¸Šçš„æ³¨è§£ä¼˜å…ˆäºç±»ä¸Šæ³¨è§£ã€‚
6. DSæ”¯æŒç»§æ‰¿æŠ½è±¡ç±»ä¸Šçš„DSï¼Œæš‚ä¸æ”¯æŒç»§æ‰¿æ¥å£ä¸Šçš„DSã€‚

> ä½¿ç”¨æ–¹æ³•

1. å¼•å…¥dynamic-datasource-spring-boot-starterã€‚

```xml
<dependency>
  <groupId>com.baomidou</groupId>
  <artifactId>dynamic-datasource-spring-boot-starter</artifactId>
  <version>${version}</version>
</dependency>
```
2. é…ç½®æ•°æ®æºã€‚

```yaml
spring:
  datasource:
    dynamic:
      primary: master #è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster
      strict: false #ä¸¥æ ¼åŒ¹é…æ•°æ®æº,é»˜è®¤false. trueæœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶æŠ›å¼‚å¸¸,falseä½¿ç”¨é»˜è®¤æ•°æ®æº
      datasource:
        master:
          url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic
          username: root
          password: 123456
          driver-class-name: com.mysql.jdbc.Driver # 3.2.0å¼€å§‹æ”¯æŒSPIå¯çœç•¥æ­¤é…ç½®
        slave_1:
          url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic
          username: root
          password: 123456
          driver-class-name: com.mysql.jdbc.Driver
        slave_2:
          url: ENC(xxxxx) # å†…ç½®åŠ å¯†,ä½¿ç”¨è¯·æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£
          username: ENC(xxxxx)
          password: ENC(xxxxx)
          driver-class-name: com.mysql.jdbc.Driver
       #......çœç•¥
       #ä»¥ä¸Šä¼šé…ç½®ä¸€ä¸ªé»˜è®¤åº“masterï¼Œä¸€ä¸ªç»„slaveä¸‹æœ‰ä¸¤ä¸ªå­åº“slave_1,slave_2
```

```yaml
# å¤šä¸»å¤šä»                      çº¯ç²¹å¤šåº“ï¼ˆè®°å¾—è®¾ç½®primaryï¼‰                   æ··åˆé…ç½®
spring:                               spring:                               spring:
  datasource:                           datasource:                           datasource:
    dynamic:                              dynamic:                              dynamic:
      datasource:                           datasource:                           datasource:
        master_1:                             mysql:                                master:
        master_2:                             oracle:                               slave_1:
        slave_1:                              sqlserver:                            slave_2:
        slave_2:                              postgresql:                           oracle_1:
        slave_3:                              h2:                                   oracle_2:
```

3. ä½¿ç”¨  **@DS**  åˆ‡æ¢æ•°æ®æºã€‚

**@DS** å¯ä»¥æ³¨è§£åœ¨æ–¹æ³•ä¸Šæˆ–ç±»ä¸Šï¼Œ**åŒæ—¶å­˜åœ¨å°±è¿‘åŸåˆ™ æ–¹æ³•ä¸Šæ³¨è§£ ä¼˜å…ˆäº ç±»ä¸Šæ³¨è§£**ã€‚

|     æ³¨è§£      |                   ç»“æœ                   |
| :-----------: | :--------------------------------------: |
|    æ²¡æœ‰@DS    |                é»˜è®¤æ•°æ®æº                |
| @DS("dsName") | dsNameå¯ä»¥ä¸ºç»„åä¹Ÿå¯ä»¥ä¸ºå…·ä½“æŸä¸ªåº“çš„åç§° |

```java
@Service
@DS("slave")
public class UserServiceImpl implements UserService {

  @Autowired
  private JdbcTemplate jdbcTemplate;

  public List selectAll() {
    return  jdbcTemplate.queryForList("select * from user");
  }
  
  @Override
  @DS("slave_1")
  public List selectByCondition() {
    return  jdbcTemplate.queryForList("select * from user where age >10");
  }
}
```


## mybatis-mate

é«˜æ•ˆç®€å•çš„`Mybatis`åŸç”Ÿæ’ä»¶å¤šæ•°æ®æºæ‰©å±•ç»„ä»¶

ğŸ‘‰ [mybatis-mate-sharding](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-sharding)

- æ³¨è§£ @Sharding

|   å±æ€§   |  ç±»å‹  | å¿…é¡»æŒ‡å®š |         é»˜è®¤å€¼         | æè¿°                         |
| :------: | :----: | :------: | :--------------------: | ---------------------------- |
|  value   | String |    æ˜¯    |           ""           | åˆ†åº“ç»„åï¼Œç©ºä½¿ç”¨é»˜è®¤ä¸»æ•°æ®æº |
| strategy | Class  |    å¦    | RandomShardingStrategy | åˆ†åº“&åˆ†è¡¨ç­–ç•¥                |

- é…ç½®

```xml
mybatis-mate:
  sharding:
    health: true # å¥åº·æ£€æµ‹
    primary: mysql # é»˜è®¤é€‰æ‹©æ•°æ®æº
    datasource:
      mysql: # æ•°æ®åº“ç»„
        - key: node1
          ...
        - key: node2
          cluster: slave # ä»åº“è¯»å†™åˆ†ç¦»æ—¶å€™è´Ÿè´£ sql æŸ¥è¯¢æ“ä½œï¼Œä¸»åº“ master é»˜è®¤å¯ä»¥ä¸å†™
          ...
      postgres:
        - key: node1 # æ•°æ®èŠ‚ç‚¹
          ...
```

- æ³¨è§£ `Sharding` åˆ‡æ¢æ•°æ®æºï¼Œç»„å†…èŠ‚ç‚¹é»˜è®¤éšæœºé€‰æ‹©ï¼ˆæŸ¥ä»å†™ä¸»ï¼‰

```java
@Mapper
@Sharding("mysql")
public interface UserMapper extends BaseMapper<User> {

    @Sharding("postgres")
    Long selectByUsername(String username);

}
```

- åˆ‡æ¢æŒ‡å®šæ•°æ®åº“èŠ‚ç‚¹

```java
// åˆ‡æ¢åˆ° mysql ä»åº“ node2 èŠ‚ç‚¹
ShardingKey.change("mysqlnode2");
```

- å¤šæ•°æ®æºåŠ¨æ€åŠ è½½å¸è½½

ğŸ‘‰ [mybatis-mate-sharding-dynamic](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-sharding-dynamic)

- å¤šæ•°æ®æºäº‹åŠ¡ï¼ˆ jta atomikosï¼‰

ğŸ‘‰ [mybatis-mate-sharding-jta-atomikos](https://gitee.com/baomidou/mybatis-mate-examples/tree/master/mybatis-mate-sharding-jta-atomikos)
